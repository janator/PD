# Домашнее задание по Hive

<p>
<details>
<summary markdown="span"><h3> Сроки сдачи </h3></summary>

| Группа | Soft deadline | Hard deadline |
| ---      |  ------  |------|
|Б05-812|11.12, 23:59|18.12, 23:59|
|Б05-824 и Б05-825|11.12, 23:59|18.12, 23:59|
|Б05-822|11.12, 23:59|18.12, 23:59|
|Б05-811|06.12, 23:59|13.12, 23:59|
|Б05-821 и Б05-831|06.12, 23:59|13.12, 23:59|
|Б05-813|07.12, 23:59|14.12, 23:59|
|Б05-823|07.12, 23:59|14.12, 23:59|
|Б05-826|07.12, 23:59|14.12, 23:59|

Исправления можно делать в течение месяца после комментариев.

* Штраф за опоздание по soft deadline: 50%
* Штраф за опоздани по hard deadline: 75%

</details>
</p>

В данном ДЗ нужно решить 6 задач:
1. Задача 1 общая для всех.
2. В остальных задачах вариант определяются с помощью [этого кода](variant_counters/get_hive_variant.py).

#### Apache HUE

Для решения задач можно использовать Apache HUE, который развернут на нашем кластере.
* Для доступа пробрасывайте порт 8888: `ssh <USER>@mipt-client -L 8888:mipt-node03.atp-fivt.org:8888`
* Список пользователей [здесь](https://docs.google.com/spreadsheets/d/e/2PACX-1vT4Rw5Q7dpju79qb4oEX2qTtq5ywIxz3NWipus-q8BbarapGxgl5oTLcFz5WeEtJxumndwrrOMhU993/pubhtml?gid=1411718772&single=true). Пароль совпадает с логином, поэтому при 1-м доступе просьба сменить пароль.

## Исходные данные: 

### I. Логи пользователей.

Данные находятся в HDFS по адресу `/data/user_logs/*_M`. Они состоят из трёх частей, каждая из которых находится в своей поддиректории. Данные в каждой части отличаются количеством и типом колонок, разделенных знаками табуляции ('\t') или пробелами.

#### А. Логи запросов пользователей к новостным сообщениям (user_logs).
1. Ip-адрес, с которого пришел запрос (STRING),
2. Время запроса (TIMESTAMP или INT),
3. Пришедший с ip-адреса http-запрос (STRING),
4. Размер переданной клиенту страницы (SMALLINT),
5. Http-статус код (SMALLINT).
6. Информация о клиентском приложении, с которого осуществлялся запрос на сервер, в том числе, информация о браузере (STRING).

**Важно:** информация о браузере содержится в начале 6-ого поля лога (символы с нулевой позиции до позиции первого пробельного символа), содержание оставшейся части строки не определяет браузер пользователя. Разделитель между IP и временем запроса имеет 3 табуляции.

#### B. Информация о пользователях (user_data).
1. IP-адрес (STRING),
2. Браузер пользователя (STRING),
3. Пол (STRING) //male, female,
4. Возраст (TINYINT).

#### С. Информация о местонахождении IP адресов пользователей (ip_data).
1. IP-адрес (STRING),
2. Регион (STRING).

### II. Подсети

Данные находятся по адресу /data/subnets. В директории 3 датасета (/data/subnets/variant[1-3], выберите соответствующий для своего варианта), но все они имеют одинаковый формат.

1. IP-адрес (STRING),
2. Маска подсети (STRING).

Датасеты в каждой директории отличаются 1-м полем.
* 1-й вариант. В качестве 1-го поля дан адрес сети.
* 2-й вариант. Адрес произвольного хоста в сети.
* 3-й вариант. Широковещательный адрес (broadcast).

Семплы находятся в `/data/subnets_S`. Если в полных данных 5000 записей, то в семплах всего 20.

## Задачи

**Задача 1 (411)**. Создайте внешние (EXTERNAL) таблицы по исходным данным. В результате будет 4 таблицы: логи пользователей, данные ip адресов, данные пользователей и подсети. Из таблицы логов перенесите данные в другую таблицу, партицированную по датам – одна партиция на каждый день. На партиционированных таблицах и нужно будет выполнять запросы в следующих задачах.

Требуется, чтобы сериализация и десериализация данных осуществлялась с использованием регулярных выражений (см. `org.apache.hadoop.hive.contrib.serde2.RegexSerDe`, `org.apache.hadoop.hive.serde2.RegexSerDe`).

Проверить правильность создания таблиц с помощью простейших запросов (`SELECT * FROM <table> LIMIT 10`). Эти Select запросы нужно также добавлять в скрипт задачи.

**Дополнительные требования:**
1. Название вашей базы данных должно совпадать с логином на **GitLab.atp-fivt.org** (например, **ivchenkoon**). 
2. Не добавляйте код создания базы в GitLab-репозиторий т.к. базы для вас уже созданы и система тестирования не имеет прав на перезаписть этих баз.
3. Таблицы должны называться так:
    * Logs - партиционированная таблица с логами.
    * Users - таблица с информацией о пользователях.
    * IPRegions - таблица с IP и регионами.
    * Subnets - таблица с подсетями для 4-й и 6-й задач

*Пример результата:*
```
33.49.147.163	http://lenta.ru/4303000	1189	451	Chrome/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)n	20140101
75.208.40.166	http://newsru.com/3330815	60	306	Safari/5.0 (Windows; U; MSIE 9.0; Windows NT 8.1; Trident/5.0; .NET4.0E; en-AU)n	20140101
```

**Задача 2.1. (421)**. Напишите запрос, выбирающий количество посещений для каждого дня. Полученные результаты отсортируйте по убыванию количества.

*Пример результата:*
```
20140308	96
20140409	96
20140318	96
```

**Задача 2.2. (422)**. Напишите запрос, выбирающий количество различных HTTP-кодов для каждого дня. Полученные результаты отсортируйте по убыванию количества.

*Пример результата:*
```
20140207	46
20140126	46
20140112	46
```

**Задача 2.3. (423)**. Напишите запрос, выбирающий количество посещений для каждого типа браузера. Браузеры берём из таблицы логов. Если 2 браузера отличаются версиями, считаем их различными.Полученные результаты отсортируйте по убыванию количества.

*Пример результата:*
```
Firefox/5.0	25
Opera/5.0	21
```

**Задача 3.1. (441)**. Напишите запрос, выбирающий количество посещений от мужчин и от женщин по регионам.

*Пример результата:*
```
Tver	66968157	29097223
Voronezh	60445347	26333509
```

**Задача 3.2. (442)**. Напишите запрос, выбирающий количество посещений от мужчин и от женщин по типам браузера (информацию о браузерах берём из таблицы логов).

*Пример результата:*
```
Firefox/5.0	1419872	621124
Opera/5.0	1426114	623333
```

**Задача 3.3. (443)**. Напишите запрос, выбирающий количество посещений от мужчин и от женщин по кодам HTTP ответов.

*Пример результата:*
```
511	90675090	39459549
412	87782696	38146030
```
Подсказка для задачи 3: используйте конструкцию [IF](https://www.folkstalk.com/2011/11/conditional-functions-in-hive.html).

**Задача 4.1 (461)**. Создать UDF «перевертыш». Функция принимает строку и возвращает данную строку записанную в обратном порядке. Подключите данную функцию к hive и выполните выборку «перевертышей» для ip адресов. Вывести TOP-10 записей.

*Пример результата:*
```
661.04.802.57
791.39.552.861
661.04.802.57
```

**Задача 4.2 (462)**. Создать UDF “мегабайт”. Функция принимает на вход число в виде строки и возвращает его же, деленное на 1024. Подключите данную функцию к hive и переведите размер HTML страницы в таблице логов в мегабайты (он дан в килобайтах). Поведение функции в аварийной ситуации (если на вход подано не число) - на ваше усмотрение (NULL, 0, пустая строка,...). Вывести TOP-10 записей.

*Пример результата:*
```
0
0
1
```

**Задача 4.3 (463)**. Создать UDF “мотиватор”. Функция принимает на вход число в виде строки и возвращает 100 - <это число>. Подключите данную функцию к hive и посчитайте, сколько лет осталось до 100 участникам логов. Поведение функции в аварийной ситуации (если на вход подано не число) - на ваше усмотрение (NULL, 0, пустая строка,...). Вывести TOP-10 записей.

*Пример результата:*
```
35
78
77
```

**Задача 5.1. (471)**. Представьте ситуацию, что все новостные сайты переехали в домен .com. Вас попросили обновить базу логов, чтоб логи пользователей указывали не на старые домены, а на новые. Например, новостная ссылка http://news.rambler.ru/8744806 теперь должна выглядеть в ваших запросах как http://news.rambler.com/8744806. Используйте стриминг в hive-sql запросе. (Рекомендуется обратить внимание на команды awk и sed). Выведите TOP-10 записей логов без сортировки.

*Пример результата:*
```
49.203.96.67	20140102	http://lenta.com/2296722	716	499	Safari/5.0
33.49.147.163	20140102	http://news.yandex.com/5605690	850	300	Safari/5.0
```

**Задача 5.2. (472)**. Аналогично, только заменяем http на ftp.

*Пример результата:*
```
222.131.187.37	20140101	ftp://news.mail.ru/8805842	1017	416	Opera/5.0
197.72.248.141	20140101	ftp://news.rambler.ru/2816512	2042	428	Safari/5.0
```

**Задача 5.3. (473)**. Аналогично, только заменяем Safari на Chrome в столбце браузеров.

*Пример результата:*
```
222.131.187.37	20140101	http://news.mail.ru/8805842	1017	416	Opera/5.0
197.72.248.141	20140101	http://news.rambler.ru/2816512	2042	428	Chrome/5.0
```

Задачи 5.х должны быть решены с использованием Hive Streaming.

**Задача 6 (491-493, bonus: 494-496)**. В терминологии сетей TCP/IP маской сети называется двоичное число, определяющее, какая часть IP-адреса узла сети относится к адресу сети, а какая – к адресу самого узла в этой сети. В маске сначала (в старших разрядах) стоят единицы, а затем с некоторого разряда – нули. Адрес сети получается в результате применения поразрядной конъюнкции к заданному IP-адресу узла и маске.

Сеть располагает некоторым диапазонов IP-адресов. 1-й адрес в диапазоне – непосредственно адрес сети, последний – широковещательный. Остальные адреса являются адресами хостов.

Требуется написать UDTF. На вход ей подаются пары:
* 1-й вариант: адрес сети и адрес маски,
* 2-й вариант: адрес произвольного хоста в сети и адрес маски,
* 3-й вариант: широковещательный адрес и адрес маски.

На выходе получаем столбец возможных IP-адресов в этой сети. Вывести TOP-100 записей.
* [Статья](http://www.netza.ru/2012/09/blog-post_6748.html), подробно объясняющая информацию про маски подсети.
* [Документация по BitSet в Java](https://docs.oracle.com/javase/7/docs/api/java/util/BitSet.html), которая может помочь при реализации.

*Пример вывода*
```
158.58.247.125
...
188.70.82.81
188.70.82.82
```
**Bonus:** рядом с IP-адресами во 2-м столбце вывести их численные значения.

*Пример вывода*
```
92.119.43.44	1551313708
92.119.43.45	1551313709
92.119.43.46	1551313710
...
158.58.247.97	2654664545
158.58.247.98	2654664546
158.58.247.99	2654664547
```

Литература
1. Tom White. Hadoop: The Definitive Guide, 3rd edition. O’Reilly, 2012, глава 12.
2. Edward Capriolo, Dean Wampler, Jason Rutherglen. Programming Hive. O’Reilly, 2012.
3. [Примеры UDTF](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-Built-inTable-GeneratingFunctions%28UDTF%29) из Hive wiki.

Ниже приведены баллы, которые вы получаете за каждую задачу.

|Задача | Ветка в репозитории | Баллы
|:--|:--|:--|
|1|hivetask1|0.4|
|2|hivetask2|0.2|
|3|hivetask3|0.3|
|4|hivetask4|0.3|
|5|hivetask5|0.3|
|6|hivetask6|0.5|
|6 (bonus)|hivetask7|+0,5|

***Если сдаёте 6-bonus, обычную 6 можно не сдавать т.к. 6-bonus - это продолжение 6. Оцениваться будет 6-bonus.***

**Комментарии**. 
1. В некоторых задачах требуется вывести TOP-N записей. Это означает просто использование LIMIT N. Сортировать результат запроса при этом не обязательно. Сортировка нужна только в задачах 2.х.
2. Пожалуйста, отправляйте на тестирование сначала снача 1-ю задачу, а потом все остальные.
3. Тестирование остальных задач происходит на таблицах, которые были созданы в 1-й задаче. Если вы неправильно сделали задачу 1, все остальные тоже не протестируются. 
4. В некоторых ситуациях ваша личная база данных Hive, на которой происходит тестирование, может быть испорчена вашими же запросами. В таком случае, заполните [**форму**](https://forms.gle/MmaPNj9NGvqpNYYr6) для её пересоздания.

** По поводу HUE **
1. У HUE свои пользователи, поэтому если работаешь с HUE нужно в нем же создать базу.
2. Если работаешь в терминале (например, пишешь UDF и тестируешь их), нужна отдельная база.
3. Для тестирования есть ещё одна база, которая совпадает с названием логина в Git. Её вообще не нужно трогать до тех пор, пока не заливаешь код в GitLab.
